<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Conjoint Lab - Standard Edition</title>
    <link rel="stylesheet" href="https://pyscript.net/releases/2024.1.1/core.css">
    <script type="module" src="https://pyscript.net/releases/2024.1.1/core.js"></script>
    <style>
        body { font-family: -apple-system, sans-serif; background: #f0f2f5; padding: 20px; }
        .container { max-width: 900px; margin: 0 auto; background: white; padding: 30px; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); }
        .card-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(260px, 1fr)); gap: 20px; margin: 20px 0; }
        .profile-card { border: 2px solid #e2e8f0; padding: 15px; border-radius: 10px; background: #fff; }
        .rank-box { background: #ebf8ff; padding: 10px; border-radius: 6px; margin-bottom: 10px; text-align: center; font-weight: bold; color: #2b6cb0; }
        .rank-input { width: 60px; font-size: 1.2rem; text-align: center; border: 2px solid #3182ce; border-radius: 4px; }
        .attr-row { display: flex; justify-content: space-between; margin: 6px 0; border-bottom: 1px solid #edf2f7; padding-bottom: 4px; }
        .attr-n { font-size: 0.8rem; color: #718096; }
        .attr-v { font-weight: bold; color: #2d3748; }
        .btn { width: 100%; padding: 18px; background: #3182ce; color: white; border: none; border-radius: 8px; font-weight: bold; cursor: pointer; font-size: 1.2rem; }
        #results { display: none; margin-top: 30px; border-top: 5px solid #3182ce; padding-top: 20px; }
        #loading-msg { text-align: center; padding: 40px; font-weight: bold; color: #3182ce; font-size: 1.2rem; }
    </style>
</head>
<body>
<div class="container">
    <h1 style="text-align:center">Credit Card Preference Study</h1>
	<p style="text-align:center; color: #0066FF;"><i>24753 Customer Analytics</i> at UTS</p>
	<p style="text-align:center; color: #0066FF;">Designed by <i>Dr. Kyuseop Kwak</i> with the aid of Gemini</p>
    <p style="text-align:center; color: #4a5568;">Rank cards from <b>1 (Favorite)</b> to <b>9 (Least Favorite)</b>.</p>
    
    <div id="loading-msg">⚙️ Profile generating ....</div>
    
    <div id="card-container" class="card-grid"></div>
    <button class="btn" py-click="analyze">Calculate My Part-Worths</button>
    <div id="status" style="text-align:center; margin-top:10px; font-weight:bold; color:#e53e3e;"></div>

    <div id="results">
        <h2 style="text-align:center">Your Personal Utility Profile</h2>
        <div id="plot-area" style="background: #fff; border-radius: 8px; padding: 10px;"></div>
    </div>
</div>

<script type="py" config='{"packages": ["numpy", "pandas", "matplotlib"]}'>
import pandas as pd
import numpy as np
import matplotlib.pyplot as plt
from pyscript import display
from js import document

attrs = {
    "Interest Rate": ["12%", "15%", "19%"],
    "Credit Limit": ["$2,000", "$5,000", "$10,000"],
    "Annual Fee": ["$0", "$50", "$100"]
}
design = [
    ["12%", "$2,000", "$0"], ["12%", "$5,000", "$50"], ["12%", "$10,000", "$100"],
    ["15%", "$2,000", "$50"], ["15%", "$5,000", "$100"], ["15%", "$10,000", "$0"],
    ["19%", "$2,000", "$100"], ["19%", "$5,000", "$0"], ["19%", "$10,000", "$50"]
]
df_p = pd.DataFrame(design, columns=list(attrs.keys()))

def setup():
    cont = document.getElementById("card-container")
    for i, r in df_p.iterrows():
        div = document.createElement("div")
        div.className = "profile-card"
        div.innerHTML = f"<div class='rank-box'>Rank: <input type='number' class='rank-input' id='r-{i}' min='1' max='9' value=''></div>"
        for c in df_p.columns:
            html = f"<div class='attr-row'><span class='attr-n'>{c}</span><span class='attr-v'>{r[c]}</span></div>"
            div.innerHTML += html
        cont.appendChild(div)
    document.getElementById("loading-msg").style.display = "none"

async def analyze(e):
    status = document.getElementById("status")
    try:
        inputs = [document.getElementById(f"r-{i}").value for i in range(9)]
        if "" in inputs:
            status.innerHTML = "⚠️ Please fill in all 9 ranks."
            return
        
        ranks = [int(x) for x in inputs]
        if len(set(ranks)) != 9:
            status.innerHTML = "⚠️ Each rank (1-9) must be unique."
            return
            
        y = 10 - np.array(ranks)
        X_list = []
        for col in df_p.columns:
            lvls = attrs[col]
            cb = {lvls[0]: [1,0], lvls[1]: [0,1], lvls[2]: [-1,-1]}
            X_list.append(np.array([cb[val] for val in df_p[col]]))
        
        X = np.column_stack([np.ones(9)] + X_list)
        betas = np.linalg.inv(X.T @ X) @ X.T @ y
        
        plt.close('all')
        fig, axes = plt.subplots(2, 2, figsize=(10, 8))
        fig.patch.set_facecolor('#f8f9fa')
        
        idx = 1
        importances = []
        flat_axes = axes.flatten()
        
        for i, (attr_name, lvl_names) in enumerate(attrs.items()):
            b = betas[idx:idx+2]
            # BACK TO ORIGINAL SIZE: Simple effects coding utility
            utils = np.append(b, -sum(b)) 
            importances.append(np.ptp(utils))
            
            ax = flat_axes[i]
            ax.plot(lvl_names, utils, marker='o', color='#3182ce', linewidth=3, markersize=8)
            ax.axhline(0, color='black', linestyle='--', linewidth=1, alpha=0.5)
            ax.set_title(f"Utility: {attr_name}", fontweight='bold')
            ax.grid(True, alpha=0.2)
            idx += 2
            
        imp_pct = [(v/sum(importances))*100 for v in importances]
        flat_axes[3].barh(list(attrs.keys()), imp_pct, color='#48bb78')
        flat_axes[3].set_title("Relative Importance (%)", fontweight='bold')
        flat_axes[3].set_xlim(0, 100)
        
        plt.tight_layout()
        document.getElementById("plot-area").innerHTML = ""
        display(fig, target="plot-area")
        document.getElementById("results").style.display = "block"
        status.innerHTML = "✅ Analysis Complete!"
    except Exception as ex:
        status.innerHTML = f"❌ Error: {str(ex)}"

setup()
</script>
</body>
</html>