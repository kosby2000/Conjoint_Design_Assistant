<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Conjoint Estimator Pro - UTS</title>
    <link rel="stylesheet" href="https://pyscript.net/releases/2024.1.1/core.css">
    <script type="module" src="https://pyscript.net/releases/2024.1.1/core.js"></script>
    <style>
        body { font-family: -apple-system, system-ui, sans-serif; line-height: 1.5; color: #333; background: #f0f4f8; padding: 20px; }
        .container { max-width: 1100px; margin: 0 auto; background: white; padding: 30px; border-radius: 12px; box-shadow: 0 4px 20px rgba(0,0,0,0.08); }
        .section { border-top: 5px solid #2ecc71; padding: 20px; margin-bottom: 25px; background: #fafafa; border-radius: 8px; border: 1px solid #eee; }
        h2 { margin-top: 0; color: #2c3e50; font-size: 1.3rem; margin-bottom: 15px; border-bottom: 1px solid #eee; padding-bottom: 10px;}
        .upload-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px; }
        .file-input-box { background: white; padding: 20px; border: 2px dashed #cbd5e0; border-radius: 10px; text-align: center; transition: 0.3s; }
        .file-input-box:hover { border-color: #2ecc71; background: #f9fffb; }
        .btn { padding: 12px 24px; cursor: pointer; border-radius: 8px; border: none; font-weight: 600; transition: 0.2s; background: #2ecc71; color: white; width: 100%; font-size: 1rem; }
        .btn:hover { background: #27ae60; transform: translateY(-1px); }
        .btn-secondary { background: #3498db; margin-top: 15px; }
        table { width: 100%; border-collapse: collapse; margin-top: 15px; font-size: 0.85rem; background: white; }
        th, td { border: 1px solid #e2e8f0; padding: 10px; text-align: center; }
        th { background: #f8fafc; color: #4a5568; }
        #loading-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(255,255,255,0.95); z-index: 9999; display: flex; justify-content: center; align-items: center; font-size: 1.2rem; font-weight: bold; color: #2ecc71; }
        .status-msg { margin-top: 15px; text-align: center; font-weight: bold; padding: 10px; border-radius: 8px; display: none; }
    </style>
</head>
<body>

<div id="loading-overlay">üöÄ Initializing Estimator...</div>

<div class="container">
    <div style="text-align: center; margin-bottom: 30px;">
        <h1 style="margin-bottom:5px;">Conjoint Part-Worth Estimator</h1>
        <p style="color: #64748b;"><i>Analyze Respondent Preferences & Attribute Importance</i></p>
    </div>

    <div class="section">
        <h2>1. Data Import</h2>
        <div class="upload-grid">
            <div class="file-input-box">
                <strong>Design Matrix (X)</strong><br>
                <small>Upload 'effects_coded_X.csv'</small><br><br>
                <input type="file" id="design-upload" accept=".csv">
            </div>
            <div class="file-input-box">
                <strong>Survey Data (Y)</strong><br>
                <small>Upload CSV (RespID, Prof1, Prof2...)</small><br><br>
                <input type="file" id="response-upload" accept=".csv">
            </div>
        </div>
        <button id="run-btn" class="btn" py-click="run_estimation">Run Regression Analysis</button>
        <div id="status-bar" class="status-msg"></div>
    </div>

    <div id="results-container" style="display:none;">
        <div class="section" style="border-top-color: #3498db;">
            <h2>2. Aggregate Model Results</h2>
            <div style="display: flex; gap: 20px; flex-wrap: wrap; align-items: flex-start;">
                <div style="flex: 1; min-width: 300px;" id="importance-table"></div>
                <div style="flex: 1; min-width: 400px; background:white; padding:15px; border-radius:8px; border:1px solid #eee;" id="importance-plot"></div>
            </div>
        </div>

        <div class="section" style="border-top-color: #f1c40f;">
            <h2>3. Individual Utilities (Part-Worths)</h2>
            <p style="font-size: 0.85rem; color: #666;">Note: Excluded levels are automatically calculated via Effects Coding constraints.</p>
            <div id="individual-table" style="overflow-x:auto; max-height: 400px;"></div>
            <button class="btn btn-secondary" py-click="download_results">üíæ Download All Part-Worths (CSV)</button>
        </div>
    </div>
</div>

<script type="py" config='{"packages": ["numpy", "pandas", "matplotlib"]}'>
import pandas as pd
import numpy as np
import matplotlib.pyplot as plt
import io
import asyncio
from pyscript import display
from js import document, Blob, URL

results_storage = {"df": None}

async def run_estimation(event):
    status = document.getElementById("status-bar")
    status.style.display = "block"
    status.style.color = "#2980b9"
    status.innerHTML = "‚è≥ <b>Calculating Part-Worths...</b> Processing individual regressions."
    
    # Allow the UI to update the status message before heavy lifting
    await asyncio.sleep(0.1)
    
    try:
        d_file = document.getElementById("design-upload").files.item(0)
        r_file = document.getElementById("response-upload").files.item(0)
        
        if not d_file or not r_file:
            status.innerHTML = "‚ùå Error: Please upload both the Design and Survey files."
            return

        # 1. Load Data
        X_df = pd.read_csv(io.StringIO(await d_file.text()))
        Y_df = pd.read_csv(io.StringIO(await r_file.text()))

        # 2. Extract Respondents and Ratings
        # Format: First col is ID, rest are profile ratings Prof1, Prof2...
        resp_ids = Y_df.iloc[:, 0]
        Y_matrix = Y_df.iloc[:, 1:].values # Respondent rows, Profile columns
        
        if X_df.shape[0] != Y_matrix.shape[1]:
            status.innerHTML = f"‚ùå Match Error: Design has {X_df.shape[0]} profiles, but Survey has {Y_matrix.shape[1]} rating columns."
            return

        # 3. Prepare Regression Matrix (Add Intercept)
        X = np.column_stack([np.ones(len(X_df)), X_df.values])
        param_names = ["Intercept"] + list(X_df.columns)
        
        all_res = []
        # Run OLS for each respondent
        for i in range(len(Y_df)):
            y = Y_matrix[i, :]
            # Betas = (X'X)^-1 X'y
            try:
                betas = np.linalg.inv(X.T @ X) @ X.T @ y
                y_hat = X @ betas
                r2 = 1 - (np.sum((y - y_hat)**2) / np.sum((y - np.mean(y))**2))
                
                row = {"RespID": resp_ids.iloc[i]}
                for idx, name in enumerate(param_names):
                    row[name] = betas[idx]
                row["R_Squared"] = r2
                all_res.append(row)
            except:
                continue

        final_df = pd.DataFrame(all_res)
        results_storage["df"] = final_df

        # 4. Attribute Importance Analysis
        attr_map = {}
        for col in X_df.columns:
            base = col.split("[")[0]
            if base not in attr_map: attr_map[base] = []
            attr_map[base].append(col)

        mean_betas = final_df[param_names[1:]].mean()
        importance_data = []
        
        for attr, levels in attr_map.items():
            pts = mean_betas[levels].values
            # Effects coding: excluded level = -sum(included levels)
            excluded_pt = -np.sum(pts)
            full_set = np.append(pts, excluded_pt)
            u_range = np.ptp(full_set)
            importance_data.append({"Attribute": attr, "Utility Range": u_range})

        imp_df = pd.DataFrame(importance_data)
        imp_df["Importance %"] = (imp_df["Utility Range"] / imp_df["Utility Range"].sum()) * 100
        imp_df = imp_df.sort_values("Importance %", ascending=False)

        # 5. Render Results
        document.getElementById("importance-table").innerHTML = "<h4>Attribute Importance</h4>" + imp_df.to_html(classes="table", index=False)
        document.getElementById("individual-table").innerHTML = final_df.head(10).to_html(classes="table", index=False)
        
        # Plotting
        plt.close('all')
        fig, ax = plt.subplots(figsize=(6, 4))
        ax.barh(imp_df["Attribute"], imp_df["Importance %"], color='#2ecc71')
        ax.set_xlabel("Importance %")
        ax.set_title("Relative Attribute Importance (Aggregate)")
        plt.tight_layout()
        document.getElementById("importance-plot").innerHTML = ""
        display(fig, target="importance-plot")

        document.getElementById("results-container").style.display = "block"
        status.innerHTML = "‚úÖ <b>Analysis Complete:</b> Part-worths estimated successfully."
        status.style.color = "#27ae60"

    except Exception as e:
        status.innerHTML = f"‚ùå <b>Error:</b> {str(e)}"
        status.style.color = "#e74c3c"

def download_results(e):
    if results_storage["df"] is not None:
        csv = results_storage["df"].to_csv(index=False)
        blob = Blob.new([csv], {"type":"text/csv"})
        link = document.createElement("a")
        link.href = URL.createObjectURL(blob)
        link.download = "conjoint_part_worths_results.csv"
        link.click()

document.getElementById("loading-overlay").style.display = "none"
</script>
</body>
</html>